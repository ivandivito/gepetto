.INCLUDE "gepetto.inc"

.EQU UIS = 0

.DSEG
CURRENT_STATE: .BYTE 1
GGR: .BYTE 1; Gepetto General Register (- - - - - - - UIS(UI state))

.CSEG
.ORG 0x00
	JMP MAIN

.ORG INT0addr
	JMP SOFT_UART_INTERRUPT

.ORG URXCaddr
	JMP USB_INTERRUPT
	
.ORG INT_VECTORS_SIZE
SOFT_UART_RX_INT:
	JMP GRBL_INTERRUPT

MAIN:
	
	;INICIALIZACION
	
	;Inicilizacion Sistema (stack pointer, timers, etc)
	
	CLR ZERO_REG
	
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R16, HIGH(RAMEND)
	OUT SPH, R16
	
	CALL BUTTONS_TIMER_INIT
	CALL BUTTONS_INIT
	
	;Inicializacion SOFTUART (Micro interprete)
	
	CALL GRBL_COM_INIT
	
	;Inicializacion USART (PC)
	
	CALL USB_INIT
	
	;Inicializacion SPI (SD)
	
	SEI
	
	;Verificar programa guardado
	
	;Configurar e inicializar GRBL

.DEF STATE_REG = R16
	
MAIN_LOOP:
	;Cargar estado
	LDS STATE_REG, STATE
	
	CPI STATE_REG, STATE_IDLE
	BREQ MAIN_IDLE
	
	CPI STATE_REG, STATE_CONNECTED
	BREQ MAIN_CONNECTED
	
	CPI STATE_REG, STATE_RUNNING
	BREQ MAIN_RUNNING
	
	RJMP MAIN_ERROR
	
	MAIN_IDLE:
		CALL IDLE_RUN
		RJMP MAIN_LOOP
		
	MAIN_CONNECTED:
		CALL CONNECTED_RUN
		RJMP MAIN_LOOP
		
	MAIN_RUNNING:
		CALL RUNNING_RUN
		RJMP MAIN_LOOP
		
	MAIN_ERROR:
		CALL IDLE_ERROR
		RJMP MAIN_LOOP
	
	